// ====================================
// ENTITY MODELS (matching your DB schema)
// ====================================

using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace YourProject.Models.Entities
{
    [Table("FormConfigurations")]
    public class FormConfiguration
    {
        [Key]
        public Guid Id { get; set; }

        [Required]
        [StringLength(100)]
        public string RequirementType { get; set; } = string.Empty;

        [StringLength(100)]
        public string? WorkflowStepId { get; set; }

        [Required]
        [StringLength(255)]
        public string Name { get; set; } = string.Empty;

        [StringLength(1000)]
        public string? Description { get; set; }

        [Required]
        [Column(TypeName = "NVARCHAR(MAX)")]
        public string ConfigurationData { get; set; } = string.Empty; // JSON

        public int Version { get; set; } = 1;
        public bool IsActive { get; set; } = true;
        public bool HasLightMode { get; set; } = true;

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime ModifiedAt { get; set; } = DateTime.UtcNow;

        [Required]
        [StringLength(255)]
        public string CreatedBy { get; set; } = string.Empty;

        // Navigation properties
        public virtual ICollection<FormDeployment> Deployments { get; set; } = new List<FormDeployment>();
        public virtual ICollection<FormSubmission> Submissions { get; set; } = new List<FormSubmission>();
    }

    [Table("FormDeployments")]
    public class FormDeployment
    {
        [Key]
        public Guid Id { get; set; }

        [Required]
        public Guid FormConfigurationId { get; set; }

        public int Version { get; set; }

        [Required]
        [StringLength(50)]
        public string Status { get; set; } = "pending_review"; // pending_review, approved, rejected, deployed, failed

        [StringLength(50)]
        public string TargetEnvironment { get; set; } = "production";

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

        [Required]
        [StringLength(255)]
        public string CreatedBy { get; set; } = string.Empty;

        public DateTime? ReviewedAt { get; set; }

        [StringLength(255)]
        public string? ReviewedBy { get; set; }

        [StringLength(1000)]
        public string? ReviewComment { get; set; }

        public DateTime? ApprovedAt { get; set; }

        [StringLength(255)]
        public string? ApprovedBy { get; set; }

        public DateTime? DeployedAt { get; set; }

        [StringLength(1000)]
        public string? ErrorMessage { get; set; }

        // Navigation properties
        [ForeignKey("FormConfigurationId")]
        public virtual FormConfiguration FormConfiguration { get; set; } = null!;
    }

    [Table("FormSubmissions")]
    public class FormSubmission
    {
        [Key]
        public Guid Id { get; set; }

        [Required]
        public Guid RequirementId { get; set; }

        [Required]
        public Guid FormConfigurationId { get; set; }

        [StringLength(100)]
        public string? WorkflowStepId { get; set; }

        [Required]
        [Column(TypeName = "NVARCHAR(MAX)")]
        public string SubmissionData { get; set; } = string.Empty; // JSON

        [Required]
        [StringLength(50)]
        public string Status { get; set; } = "draft"; // draft, submitted, approved, rejected

        public bool IsLightMode { get; set; }

        public DateTime? SubmittedAt { get; set; }

        [StringLength(255)]
        public string? SubmittedBy { get; set; }

        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime ModifiedAt { get; set; } = DateTime.UtcNow;

        [Required]
        [StringLength(255)]
        public string CreatedBy { get; set; } = string.Empty;

        // Navigation properties
        [ForeignKey("FormConfigurationId")]
        public virtual FormConfiguration FormConfiguration { get; set; } = null!;
    }

    // Validation result class for business logic
    public class ValidationResult
    {
        public bool IsValid { get; set; }
        public List<ValidationError> Errors { get; set; } = new();
        public List<ValidationError> Warnings { get; set; } = new();
        public List<ValidationError> Suggestions { get; set; } = new();
    }

    public class ValidationError
    {
        public string Field { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
        public string Severity { get; set; } = "error"; // error, warning, info
        public object? Value { get; set; }
    }
}

// ====================================
// SERVICE INTERFACE
// ====================================

using YourProject.Models.Entities;

namespace YourProject.Services
{
    public interface IFormConfigurationService
    {
        // Form Configuration CRUD
        Task<FormConfiguration?> GetFormConfigurationAsync(string requirementType, List<string> userRoles, string currentUserId);
        Task<FormConfiguration?> GetFormConfigurationByIdAsync(Guid id, string currentUserId);
        Task<FormConfiguration> CreateFormConfigurationAsync(FormConfiguration formConfiguration);
        Task<FormConfiguration> UpdateFormConfigurationAsync(FormConfiguration formConfiguration);
        Task DeleteFormConfigurationAsync(Guid id);
        Task<List<FormConfiguration>> GetAllFormConfigurationsAsync(string? requirementType = null, bool includeInactive = false);

        // Deployments (4-Eyes Principle)
        Task<FormDeployment> CreateDeploymentAsync(FormDeployment deployment);
        Task<FormDeployment> UpdateDeploymentAsync(FormDeployment deployment);
        Task<FormDeployment?> GetDeploymentByIdAsync(Guid deploymentId);
        Task<List<FormDeployment>> GetDeploymentHistoryAsync(Guid formConfigurationId);
        Task ExecuteDeploymentAsync(Guid deploymentId);

        // Form Submissions
        Task<FormSubmission> CreateSubmissionAsync(FormSubmission submission);
        Task<FormSubmission?> GetSubmissionByIdAsync(Guid submissionId, string currentUserId);
        Task<List<FormSubmission>> GetSubmissionsByRequirementAsync(Guid requirementId);
        Task<bool> HasSubmissionsAsync(Guid formConfigurationId);

        // Validation
        Task<ValidationResult> ValidateFormConfigurationAsync(object formData);
        Task<ValidationResult> ValidateSubmissionAsync(Guid formConfigurationId, Dictionary<string, object> fieldValues);

        // Analytics & Usage
        Task<object> GetFormUsageStatsAsync(Guid formConfigurationId, DateTime? startDate = null, DateTime? endDate = null);

        // Templates
        Task<List<object>> GetFormTemplatesAsync(string? category = null);
        Task<FormConfiguration> CreateFormFromTemplateAsync(Guid templateId, string name, string requirementType, Dictionary<string, object>? fieldMappings = null);

        // Permissions
        Task<object> GetFormPermissionsAsync(Guid formConfigurationId, string currentUserId);

        // Import/Export
        Task<byte[]> ExportFormConfigurationAsync(Guid formConfigurationId, string format);
        Task<object> ImportFormConfigurationAsync(Stream fileStream, bool overwriteExisting, bool validateOnly);
    }

    public interface IWorkflowService
    {
        Task<List<WorkflowStep>> GetWorkflowStepsAsync(string requirementType);
    }

    public interface ICurrentUserService
    {
        string GetCurrentUserId();
        string GetCurrentUserName();
        List<string> GetCurrentUserRoles();
    }

    // Simple workflow step model for form integration
    public class WorkflowStep
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }
}

// ====================================
// SERVICE IMPLEMENTATION
// ====================================

using Microsoft.EntityFrameworkCore;
using Newtonsoft.Json;
using YourProject.Data;
using YourProject.Models.Entities;

namespace YourProject.Services.Implementation
{
    public class FormConfigurationService : IFormConfigurationService
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<FormConfigurationService> _logger;
        private readonly ICurrentUserService _currentUserService;

        public FormConfigurationService(
            ApplicationDbContext context,
            ILogger<FormConfigurationService> logger,
            ICurrentUserService currentUserService)
        {
            _context = context;
            _logger = logger;
            _currentUserService = currentUserService;
        }

        // ==================== FORM CONFIGURATION CRUD ====================

        public async Task<FormConfiguration?> GetFormConfigurationAsync(
            string requirementType, 
            List<string> userRoles, 
            string currentUserId)
        {
            var config = await _context.FormConfigurations
                .Where(fc => fc.RequirementType == requirementType && fc.IsActive)
                .OrderByDescending(fc => fc.Version)
                .FirstOrDefaultAsync();

            if (config != null)
            {
                // Apply role-based filtering to configuration data
                config.ConfigurationData = ApplyPermissionFiltering(config.ConfigurationData, userRoles);
            }

            return config;
        }

        public async Task<FormConfiguration?> GetFormConfigurationByIdAsync(Guid id, string currentUserId)
        {
            return await _context.FormConfigurations
                .Include(fc => fc.Deployments)
                .FirstOrDefaultAsync(fc => fc.Id == id);
        }

        public async Task<FormConfiguration> CreateFormConfigurationAsync(FormConfiguration formConfiguration)
        {
            // Validate configuration data
            var validationResult = await ValidateFormConfigurationAsync(formConfiguration.ConfigurationData);
            if (!validationResult.IsValid)
            {
                throw new InvalidOperationException($"Form configuration is invalid: {string.Join(", ", validationResult.Errors.Select(e => e.Message))}");
            }

            _context.FormConfigurations.Add(formConfiguration);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Created form configuration: {FormId} for requirement type: {RequirementType}",
                formConfiguration.Id, formConfiguration.RequirementType);

            return formConfiguration;
        }

        public async Task<FormConfiguration> UpdateFormConfigurationAsync(FormConfiguration formConfiguration)
        {
            // Validate configuration data
            var validationResult = await ValidateFormConfigurationAsync(formConfiguration.ConfigurationData);
            if (!validationResult.IsValid)
            {
                throw new InvalidOperationException($"Form configuration is invalid: {string.Join(", ", validationResult.Errors.Select(e => e.Message))}");
            }

            _context.FormConfigurations.Update(formConfiguration);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Updated form configuration: {FormId}", formConfiguration.Id);

            return formConfiguration;
        }

        public async Task DeleteFormConfigurationAsync(Guid id)
        {
            var config = await _context.FormConfigurations.FindAsync(id);
            if (config == null)
            {
                throw new InvalidOperationException("Form configuration not found");
            }

            // Check if there are any submissions
            var hasSubmissions = await _context.FormSubmissions.AnyAsync(fs => fs.FormConfigurationId == id);
            if (hasSubmissions)
            {
                throw new InvalidOperationException("Cannot delete form configuration with existing submissions");
            }

            _context.FormConfigurations.Remove(config);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Deleted form configuration: {FormId}", id);
        }

        public async Task<List<FormConfiguration>> GetAllFormConfigurationsAsync(string? requirementType = null, bool includeInactive = false)
        {
            var query = _context.FormConfigurations.AsQueryable();

            if (!string.IsNullOrEmpty(requirementType))
            {
                query = query.Where(fc => fc.RequirementType == requirementType);
            }

            if (!includeInactive)
            {
                query = query.Where(fc => fc.IsActive);
            }

            return await query.OrderBy(fc => fc.RequirementType).ThenBy(fc => fc.Name).ToListAsync();
        }

        // ==================== DEPLOYMENTS ====================

        public async Task<FormDeployment> CreateDeploymentAsync(FormDeployment deployment)
        {
            _context.FormDeployments.Add(deployment);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Created deployment: {DeploymentId} for form: {FormId}",
                deployment.Id, deployment.FormConfigurationId);

            return deployment;
        }

        public async Task<FormDeployment> UpdateDeploymentAsync(FormDeployment deployment)
        {
            _context.FormDeployments.Update(deployment);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Updated deployment: {DeploymentId}", deployment.Id);

            return deployment;
        }

        public async Task<FormDeployment?> GetDeploymentByIdAsync(Guid deploymentId)
        {
            return await _context.FormDeployments
                .Include(fd => fd.FormConfiguration)
                .FirstOrDefaultAsync(fd => fd.Id == deploymentId);
        }

        public async Task<List<FormDeployment>> GetDeploymentHistoryAsync(Guid formConfigurationId)
        {
            return await _context.FormDeployments
                .Where(fd => fd.FormConfigurationId == formConfigurationId)
                .OrderByDescending(fd => fd.CreatedAt)
                .ToListAsync();
        }

        public async Task ExecuteDeploymentAsync(Guid deploymentId)
        {
            var deployment = await GetDeploymentByIdAsync(deploymentId);
            if (deployment == null)
            {
                throw new InvalidOperationException("Deployment not found");
            }

            if (deployment.Status != "approved")
            {
                throw new InvalidOperationException("Deployment must be approved before execution");
            }

            try
            {
                // Here you would implement the actual deployment logic
                // For example: sync to production database, update caches, etc.
                
                // Simulate deployment process
                await Task.Delay(1000);

                // Mark as deployed
                deployment.Status = "deployed";
                deployment.DeployedAt = DateTime.UtcNow;

                await UpdateDeploymentAsync(deployment);

                _logger.LogInformation("Successfully executed deployment: {DeploymentId}", deploymentId);
            }
            catch (Exception ex)
            {
                deployment.Status = "failed";
                deployment.ErrorMessage = ex.Message;
                await UpdateDeploymentAsync(deployment);

                _logger.LogError(ex, "Failed to execute deployment: {DeploymentId}", deploymentId);
                throw;
            }
        }

        // ==================== FORM SUBMISSIONS ====================

        public async Task<FormSubmission> CreateSubmissionAsync(FormSubmission submission)
        {
            _context.FormSubmissions.Add(submission);
            await _context.SaveChangesAsync();

            _logger.LogInformation("Created form submission: {SubmissionId} for requirement: {RequirementId}",
                submission.Id, submission.RequirementId);

            return submission;
        }

        public async Task<FormSubmission?> GetSubmissionByIdAsync(Guid submissionId, string currentUserId)
        {
            return await _context.FormSubmissions
                .Include(fs => fs.FormConfiguration)
                .FirstOrDefaultAsync(fs => fs.Id == submissionId);
        }

        public async Task<List<FormSubmission>> GetSubmissionsByRequirementAsync(Guid requirementId)
        {
            return await _context.FormSubmissions
                .Where(fs => fs.RequirementId == requirementId)
                .OrderByDescending(fs => fs.CreatedAt)
                .ToListAsync();
        }

        public async Task<bool> HasSubmissionsAsync(Guid formConfigurationId)
        {
            return await _context.FormSubmissions
                .AnyAsync(fs => fs.FormConfigurationId == formConfigurationId);
        }

        // ==================== VALIDATION ====================

        public async Task<ValidationResult> ValidateFormConfigurationAsync(object formData)
        {
            var result = new ValidationResult { IsValid = true };

            try
            {
                // Parse configuration data
                dynamic config;
                if (formData is string jsonString)
                {
                    config = JsonConvert.DeserializeObject(jsonString);
                }
                else
                {
                    config = formData;
                }

                // Validate structure
                if (config?.fields == null)
                {
                    result.Errors.Add(new ValidationError
                    {
                        Field = "fields",
                        Message = "Form must have at least one field",
                        Code = "MISSING_FIELDS"
                    });
                    result.IsValid = false;
                }

                if (config?.sections == null)
                {
                    result.Errors.Add(new ValidationError
                    {
                        Field = "sections",
                        Message = "Form must have at least one section",
                        Code = "MISSING_SECTIONS"
                    });
                    result.IsValid = false;
                }

                // Additional validation logic here...
                
            }
            catch (Exception ex)
            {
                result.Errors.Add(new ValidationError
                {
                    Field = "configuration",
                    Message = $"Invalid configuration format: {ex.Message}",
                    Code = "INVALID_FORMAT"
                });
                result.IsValid = false;
            }

            return result;
        }

        public async Task<ValidationResult> ValidateSubmissionAsync(Guid formConfigurationId, Dictionary<string, object> fieldValues)
        {
            var result = new ValidationResult { IsValid = true };

            var formConfig = await GetFormConfigurationByIdAsync(formConfigurationId, _currentUserService.GetCurrentUserId());
            if (formConfig == null)
            {
                result.Errors.Add(new ValidationError
                {
                    Field = "form",
                    Message = "Form configuration not found",
                    Code = "FORM_NOT_FOUND"
                });
                result.IsValid = false;
                return result;
            }

            try
            {
                var configData = JsonConvert.DeserializeObject<dynamic>(formConfig.ConfigurationData);
                var fields = JsonConvert.DeserializeObject<List<dynamic>>(configData?.fields?.ToString() ?? "[]");

                // Validate required fields
                foreach (var field in fields)
                {
                    var fieldName = field.name?.ToString();
                    var isRequired = field.required ?? false;

                    if (isRequired && !fieldValues.ContainsKey(fieldName))
                    {
                        result.Errors.Add(new ValidationError
                        {
                            Field = fieldName,
                            Message = $"Field '{field.label}' is required",
                            Code = "REQUIRED_FIELD_MISSING"
                        });
                        result.IsValid = false;
                    }
                }

                // Additional field-specific validation could go here...

            }
            catch (Exception ex)
            {
                result.Errors.Add(new ValidationError
                {
                    Field = "submission",
                    Message = $"Validation error: {ex.Message}",
                    Code = "VALIDATION_ERROR"
                });
                result.IsValid = false;
            }

            return result;
        }

        // ==================== ANALYTICS & USAGE ====================

        public async Task<object> GetFormUsageStatsAsync(Guid formConfigurationId, DateTime? startDate = null, DateTime? endDate = null)
        {
            var start = startDate ?? DateTime.UtcNow.AddDays(-30);
            var end = endDate ?? DateTime.UtcNow;

            var submissions = await _context.FormSubmissions
                .Where(fs => fs.FormConfigurationId == formConfigurationId 
                    && fs.CreatedAt >= start 
                    && fs.CreatedAt <= end)
                .ToListAsync();

            return new
            {
                formConfigurationId = formConfigurationId.ToString(),
                totalSubmissions = submissions.Count,
                uniqueUsers = submissions.Select(s => s.CreatedBy).Distinct().Count(),
                averageCompletionTime = 0, // Would calculate from submission data
                abandonmentRate = 0.0,
                conversionRate = submissions.Count(s => s.Status == "submitted") / (double)submissions.Count * 100,
                lightModeUsage = submissions.Count(s => s.IsLightMode) / (double)submissions.Count * 100,
                fieldAnalytics = new List<object>(),
                mostUsedFields = new List<string>(),
                leastUsedFields = new List<string>(),
                errorFrequency = new List<object>(),
                usageTrend = new List<object>(),
                deviceBreakdown = new { desktop = 70, mobile = 25, tablet = 5 },
                browserBreakdown = new Dictionary<string, int>()
            };
        }

        // ==================== TEMPLATES ====================

        public async Task<List<object>> GetFormTemplatesAsync(string? category = null)
        {
            // This would typically come from a templates table
            // For now, return some mock templates
            var templates = new List<object>
            {
                new
                {
                    id = "template-basic",
                    name = "Basic Request Form",
                    description = "Standard form for basic requirements",
                    category = "standard",
                    requirementType = "Kleinanforderung",
                    usageCount = 25,
                    isPublic = true
                }
            };

            return category == null ? templates : templates.Where(t => ((dynamic)t).category == category).ToList();
        }

        public async Task<FormConfiguration> CreateFormFromTemplateAsync(
            Guid templateId, 
            string name, 
            string requirementType, 
            Dictionary<string, object>? fieldMappings = null)
        {
            // Load template and create new form configuration
            // This is a simplified implementation
            var newConfig = new FormConfiguration
            {
                Id = Guid.NewGuid(),
                Name = name,
                RequirementType = requirementType,
                ConfigurationData = "{}",
                Version = 1,
                IsActive = true,
                HasLightMode = true,
                CreatedAt = DateTime.UtcNow,
                ModifiedAt = DateTime.UtcNow,
                CreatedBy = _currentUserService.GetCurrentUserName()
            };

            return await CreateFormConfigurationAsync(newConfig);
        }

        // ==================== PERMISSIONS ====================

        public async Task<object> GetFormPermissionsAsync(Guid formConfigurationId, string currentUserId)
        {
            var userRoles = _currentUserService.GetCurrentUserRoles();
            
            // This would typically check against the form's permission configuration
            // and the user's roles to determine what they can do
            return new
            {
                canView = true,
                canEdit = userRoles.Contains("Administrator") || userRoles.Contains("Manager"),
                canDeploy = userRoles.Contains("Administrator") || userRoles.Contains("Approver"),
                canDelete = userRoles.Contains("Administrator"),
                restrictedFields = new List<string>()
            };
        }

        // ==================== IMPORT/EXPORT ====================

        public async Task<byte[]> ExportFormConfigurationAsync(Guid formConfigurationId, string format)
        {
            var config = await GetFormConfigurationByIdAsync(formConfigurationId, _currentUserService.GetCurrentUserId());
            if (config == null)
            {
                throw new InvalidOperationException("Form configuration not found");
            }

            if (format.ToLower() == "json")
            {
                var jsonString = JsonConvert.SerializeObject(config, Formatting.Indented);
                return System.Text.Encoding.UTF8.GetBytes(jsonString);
            }
            else if (format.ToLower() == "excel")
            {
                // Would implement Excel export here
                throw new NotImplementedException("Excel export not yet implemented");
            }

            throw new ArgumentException($"Unsupported export format: {format}");
        }

        public async Task<object> ImportFormConfigurationAsync(Stream fileStream, bool overwriteExisting, bool validateOnly)
        {
            var importedForms = new List<FormConfiguration>();
            var errors = new List<string>();

            try
            {
                using var reader = new StreamReader(fileStream);
                var content = await reader.ReadToEndAsync();
                
                var importedData = JsonConvert.DeserializeObject<FormConfiguration[]>(content);
                
                if (importedData == null)
                {
                    errors.Add("Invalid file format");
                    return new { success = false, importedForms, errors };
                }

                foreach (var config in importedData)
                {
                    try
                    {
                        // Validate configuration
                        var validationResult = await ValidateFormConfigurationAsync(config.ConfigurationData);
                        if (!validationResult.IsValid)
                        {
                            errors.Add($"Validation failed for '{config.Name}': {string.Join(", ", validationResult.Errors.Select(e => e.Message))}");
                            continue;
                        }

                        if (!validateOnly)
                        {
                            // Check if exists
                            var existing = await _context.FormConfigurations
                                .FirstOrDefaultAsync(fc => fc.RequirementType == config.RequirementType && fc.Name == config.Name);

                            if (existing != null && !overwriteExisting)
                            {
                                errors.Add($"Form '{config.Name}' already exists for requirement type '{config.RequirementType}'");
                                continue;
                            }

                            // Create or update
                            config.Id = Guid.NewGuid();
                            config.CreatedAt = DateTime.UtcNow;
                            config.ModifiedAt = DateTime.UtcNow;
                            config.CreatedBy = _currentUserService.GetCurrentUserName();

                            if (existing != null)
                            {
                                // Update existing
                                existing.ConfigurationData = config.ConfigurationData;
                                existing.ModifiedAt = DateTime.UtcNow;
                                existing.Version++;
                                importedForms.Add(existing);
                            }
                            else
                            {
                                // Create new
                                var created = await CreateFormConfigurationAsync(config);
                                importedForms.Add(created);
                            }
                        }
                        else
                        {
                            importedForms.Add(config);
                        }
                    }
                    catch (Exception ex)
                    {
                        errors.Add($"Error processing '{config.Name}': {ex.Message}");
                    }
                }

                return new
                {
                    success = errors.Count == 0,
                    importedForms,
                    errors
                };
            }
            catch (Exception ex)
            {
                errors.Add($"Import failed: {ex.Message}");
                return new { success = false, importedForms, errors };
            }
        }

        // ==================== HELPER METHODS ====================

        private string ApplyPermissionFiltering(string configurationData, List<string> userRoles)
        {
            try
            {
                var config = JsonConvert.DeserializeObject<dynamic>(configurationData);
                
                // Filter fields based on user roles
                if (config?.fields != null)
                {
                    var filteredFields = new List<dynamic>();
                    foreach (var field in config.fields)
                    {
                        var permissions = field.permissions;
                        if (permissions != null)
                        {
                            var allowedRoles = JsonConvert.DeserializeObject<List<string>>(permissions.allowedRoles?.ToString() ?? "[]");
                            var hideFromRoles = JsonConvert.DeserializeObject<List<string>>(permissions.hideFromRoles?.ToString() ?? "[]");
                            
                            // Check if user should see this field
                            var hasAllowedRole = allowedRoles.Count == 0 || allowedRoles.Any(role => userRoles.Contains(role));
                            var isHidden = hideFromRoles.Any(role => userRoles.Contains(role));
                            
                            if (hasAllowedRole && !isHidden)
                            {
                                // Check if field should be read-only
                                var readOnlyRoles = JsonConvert.DeserializeObject<List<string>>(permissions.readOnlyRoles?.ToString() ?? "[]");
                                if (readOnlyRoles.Any(role => userRoles.Contains(role)))
                                {
                                    field.disabled = true;
                                }
                                
                                filteredFields.Add(field);
                            }
                        }
                        else
                        {
                            filteredFields.Add(field);
                        }
                    }
                    config.fields = filteredFields;
                }

                return JsonConvert.SerializeObject(config);
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, "Failed to apply permission filtering, returning original configuration");
                return configurationData;
            }
        }
    }

    // ==================== CURRENT USER SERVICE IMPLEMENTATION ====================

    public class CurrentUserService : ICurrentUserService
    {
        private readonly IHttpContextAccessor _httpContextAccessor;

        public CurrentUserService(IHttpContextAccessor httpContextAccessor)
        {
            _httpContextAccessor = httpContextAccessor;
        }

        public string GetCurrentUserId()
        {
            var context = _httpContextAccessor.HttpContext;
            return context?.User?.FindFirst("sub")?.Value 
                ?? context?.User?.FindFirst("id")?.Value 
                ?? "unknown";
        }

        public string GetCurrentUserName()
        {
            var context = _httpContextAccessor.HttpContext;
            return context?.User?.FindFirst("name")?.Value 
                ?? context?.User?.FindFirst("username")?.Value 
                ?? context?.User?.Identity?.Name 
                ?? "Unknown User";
        }

        public List<string> GetCurrentUserRoles()
        {
            var context = _httpContextAccessor.HttpContext;
            return context?.User?.FindAll("role")?.Select(c => c.Value).ToList() 
                ?? new List<string>();
        }
    }

    // ==================== SIMPLE WORKFLOW SERVICE IMPLEMENTATION ====================

    public class WorkflowService : IWorkflowService
    {
        private readonly ApplicationDbContext _context;

        public WorkflowService(ApplicationDbContext context)
        {
            _context = context;
        }

        public async Task<List<WorkflowStep>> GetWorkflowStepsAsync(string requirementType)
        {
            // This would typically query your WorkflowConfigurations table
            // For now, return some mock data
            await Task.Delay(1); // Simulate async operation

            return requirementType switch
            {
                "Kleinanforderung" => new List<WorkflowStep>
                {
                    new() { Id = "step-1", Name = "Erfassung" },
                    new() { Id = "step-2", Name = "Fachliche Prüfung" },
                    new() { Id = "step-3", Name = "Genehmigung" },
                    new() { Id = "step-4", Name = "Umsetzung" }
                },
                "Großanforderung" => new List<WorkflowStep>
                {
                    new() { Id = "step-1", Name = "Erfassung" },
                    new() { Id = "step-2", Name = "Fachliche Prüfung" },
                    new() { Id = "step-3", Name = "Technische Prüfung" },
                    new() { Id = "step-4", Name = "Management Genehmigung" },
                    new() { Id = "step-5", Name = "Umsetzung" },
                    new() { Id = "step-6", Name = "Testing" },
                    new() { Id = "step-7", Name = "Deployment" }
                },
                _ => new List<WorkflowStep>
                {
                    new() { Id = "step-1", Name = "Erfassung" },
                    new() { Id = "step-2", Name = "Bearbeitung" },
                    new() { Id = "step-3", Name = "Abschluss" }
                }
            };
        }
    }
}
